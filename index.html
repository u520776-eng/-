<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- 安全防護：CSP 限制外部腳本注入，僅允許自帶腳本與信任的 Tailwind CDN -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self'; media-src 'self' blob: data:;">
    
    <title>萬德莊嚴念佛修行</title>
    
    <!-- PWA 手機全螢幕設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="萬德莊嚴">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --buddha-gold: #fbbf24;
            --font-main: "PingFang TC", "Heiti TC", "Microsoft JhengHei", "Noto Sans TC", sans-serif;
        }

        * {
            font-family: var(--font-main) !important;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            background-color: #020617;
            color: white;
            margin: 0;
            overflow: hidden;
            user-select: none;
            cursor: pointer;
            height: 100vh;
        }

        /* 介面動畫特效 */
        .wheel-container { animation: rotate-slow 140s linear infinite; }
        @keyframes rotate-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .ripple-ring {
            position: absolute; border-radius: 50%; border: 2px solid rgba(251, 191, 36, 0.4);
            pointer-events: none; z-index: 5; transform: translate(-50%, -50%);
            animation: ripple-spread 4s cubic-bezier(0.1, 0.2, 0.3, 1) forwards;
        }
        @keyframes ripple-spread { 0% { width: 0; height: 0; opacity: 1; border-width: 6px; } 100% { width: 1600px; height: 1600px; opacity: 0; border-width: 1px; } }

        .sun-flash {
            position: absolute; border-radius: 50%;
            background: radial-gradient(circle, rgba(251, 191, 36, 0.6) 0%, rgba(251, 191, 36, 0.1) 60%, transparent 80%);
            pointer-events: none; z-index: 4; transform: translate(-50%, -50%);
            animation: flash-fade 2.5s ease-out forwards;
        }
        @keyframes flash-fade { 0% { width: 0; height: 0; opacity: 1; filter: blur(5px); } 100% { width: 900px; height: 900px; opacity: 0; filter: blur(20px); } }

        .lotus-btn { transition: all 0.3s ease; animation: lotus-breathe 4s infinite ease-in-out; z-index: 20; }
        @keyframes lotus-breathe { 0%, 100% { transform: scale(1); filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.3)); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 20px rgba(251, 191, 36, 0.6)); } }
        .lotus-btn:active { transform: scale(0.9); }

        .center-glow { text-shadow: 0 0 15px rgba(251, 191, 36, 0.8), 0 0 30px rgba(251, 191, 36, 0.4); animation: constant-glow 4s infinite ease-in-out; }
        @keyframes constant-glow { 0%, 100% { text-shadow: 0 0 15px rgba(251, 191, 36, 0.8); opacity: 0.9; } 50% { text-shadow: 0 0 25px rgba(251, 191, 36, 1); opacity: 1; } }

        .chant-unit { transition: color 0.8s ease, text-shadow 0.8s ease; font-size: 8px; font-weight: bold; }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .nav-link { transition: all 0.3s ease; color: #ffffff; font-weight: bold; font-size: 0.875rem; letter-spacing: 0.1em; padding: 8px 12px; white-space: nowrap; }
        .nav-link:active { color: #fbbf24; transform: scale(0.95); }

        .modal-base { background: rgba(0, 0, 0, 0.95); border: 1px solid rgba(251, 191, 36, 0.3); backdrop-filter: blur(15px); }
        .menu-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.4s ease; }

        #notification {
            position: fixed; top: -120px; left: 50%; transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.95); color: #fbbf24; padding: 14px 40px; border-radius: 99px;
            font-size: 14px; font-weight: bold; letter-spacing: 2px; z-index: 600;
            transition: top 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); border: 1px solid rgba(251, 191, 36, 0.3);
            text-align: center; width: 85%; max-width: 340px;
        }
        #notification.show { top: 40px; }

        .voice-active { color: #fbbf24 !important; text-shadow: 0 0 10px #fbbf24; animation: pulse-small 2s infinite; }
        @keyframes pulse-small { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

        .bottom-controls-group { display: grid; grid-template-columns: 1fr auto 1fr; grid-template-rows: auto auto auto; align-items: center; justify-items: center; width: 100%; max-width: 400px; margin-bottom: 20px; }
    </style>
</head>
<body onpointerdown="handleGlobalClick(event)">

    <div id="app" class="relative min-h-screen flex flex-col bg-[#010409]">
        <div id="notification">修行提醒：已超過 24 小時未修持，境界已退轉一品。</div>

        <!-- ================= 首頁 ================= -->
        <div id="homeView" class="fixed inset-0 z-[200] flex flex-col items-center justify-center p-8 bg-[#010409] fade-in">
            <h1 class="text-3xl font-bold tracking-[0.5em] text-white mb-4 text-center">萬德莊嚴</h1>
            <p class="text-stone-500 text-sm tracking-[0.3em] mb-12 text-center">請選擇修行聖號或咒語</p>
            <div class="grid grid-cols-1 gap-6 w-full max-w-xs mx-auto">
                <button onclick="selectMantra('guanyin')" class="menu-card py-6 rounded-3xl text-center"><div class="text-amber-500 text-lg font-bold tracking-widest">南無觀世音菩薩</div></button>
                <button onclick="selectMantra('dizang')" class="menu-card py-6 rounded-3xl text-center"><div class="text-amber-500 text-lg font-bold tracking-widest">南無地藏王菩薩</div></button>
                <button onclick="selectMantra('mani')" class="menu-card py-6 rounded-3xl text-center"><div class="text-amber-500 text-lg font-bold tracking-widest">嗡嘛呢貝美吽</div></button>
                <button onclick="selectMantra('amitabha')" class="menu-card py-6 rounded-3xl text-center border-amber-600/20 bg-amber-600/5"><div class="text-amber-500 text-lg font-bold tracking-widest">南無阿彌陀佛</div></button>
            </div>
            <p class="mt-16 text-[10px] text-stone-700 tracking-[0.4em] uppercase font-bold italic text-center">加密保護版 · 完整性校驗啟動</p>
        </div>

        <!-- ================= 修行介面 ================= -->
        <div id="practiceUI" class="hidden flex flex-col min-h-screen">
            <div class="absolute top-10 left-6 z-30 pointer-events-none">
                <h1 id="gradeLabel" class="text-xl font-bold tracking-widest text-amber-500">下品下生</h1>
                <p id="subTitleLabel" class="text-[9px] text-stone-500 tracking-[0.3em] uppercase mt-1">九品往生修行錄</p>
            </div>
            <div class="absolute top-10 right-6 z-30 text-right flex flex-col items-end gap-3 pointer-events-none">
                <div><p class="text-[8px] text-stone-500 uppercase tracking-widest">今日進度</p><p id="progressLabel" class="text-lg font-bold text-amber-200">0 / 108</p></div>
                <div class="w-12 h-[1px] bg-stone-800 my-1"></div>
                <div><p class="text-[8px] text-stone-500 uppercase tracking-widest">累計功德</p><p id="totalCountDisplay" class="text-lg font-bold text-white">0</p></div>
            </div>

            <main id="mainView" class="flex-1 flex flex-col items-center justify-center relative p-4">
                <div id="wheelWrapper" class="relative w-[340px] h-[340px] xs:w-[380px] xs:h-[380px] flex items-center justify-center">
                    <div id="mantraWheel" class="wheel-container relative w-full h-full"></div>
                    <div id="centerMantra" class="absolute text-amber-400 font-bold text-xl z-10 center-glow pointer-events-none text-center leading-tight">南無<br>阿彌陀佛</div>
                </div>
            </main>

            <div class="flex justify-center pb-12 z-40">
                <div class="bottom-controls-group">
                    <div class="col-start-2 flex justify-center py-2"><button onclick="event.stopPropagation(); backToHome()" class="nav-link text-white underline underline-offset-8">切換聖號</button></div>
                    <div class="col-start-1 self-end py-2"><button onclick="event.stopPropagation(); showGardenTab()" class="nav-link">功德林</button></div>
                    <div class="col-start-2 row-start-2 row-span-2">
                        <div id="lotusBtnContainer" class="lotus-btn">
                            <svg viewBox="0 0 100 100" width="100" height="100">
                                <defs><radialGradient id="lotusCenterGlow" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#fbbf24" stop-opacity="0.9" /><stop offset="100%" stop-color="#fbbf24" stop-opacity="0" /></radialGradient></defs>
                                <g stroke="#fbbf24" stroke-width="1.2" fill="none">
                                    <path d="M50 50 Q65 15 50 5 Q35 15 50 50" transform="rotate(0, 50, 50)" /><path d="M50 50 Q65 15 50 5 Q35 15 50 50" transform="rotate(45, 50, 50)" /><path d="M50 50 Q65 15 50 5 Q35 15 50 50" transform="rotate(90, 50, 50)" /><path d="M50 50 Q65 15 50 5 Q35 15 50 50" transform="rotate(135, 50, 50)" /><path d="M50 50 Q65 15 50 5 Q35 15 50 50" transform="rotate(180, 50, 50)" /><path d="M50 50 Q65 15 50 5 Q35 15 50 50" transform="rotate(225, 50, 50)" /><path d="M50 50 Q65 15 50 5 Q35 15 50 50" transform="rotate(270, 50, 50)" /><path d="M50 50 Q65 15 50 5 Q35 15 50 50" transform="rotate(315, 50, 50)" />
                                </g>
                                <circle cx="50" cy="50" r="10" fill="url(#lotusCenterGlow)" />
                            </svg>
                        </div>
                    </div>
                    <div class="col-start-3 self-end py-2"><button onclick="event.stopPropagation(); toggleVoiceMode()" id="voiceBtn" class="nav-link flex items-center gap-1"><span>語音計數</span><svg id="micIcon" viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg></button></div>
                    <div class="col-start-1 self-start py-2"><button onclick="event.stopPropagation(); showMantraInfo()" class="nav-link">功德說明</button></div>
                    <div class="col-start-3 self-start py-2"><button onclick="event.stopPropagation(); showDedication()" class="nav-link">迴向偈</button></div>
                </div>
            </div>
        </div>

        <!-- 功能視窗 (說明/功德林/偈語/圓滿/迴向) -->
        <div id="infoModal" class="fixed inset-0 z-[260] hidden items-center justify-center p-6 bg-black/80" onclick="closeMantraInfo()"><div class="modal-base max-w-sm w-full p-10 rounded-3xl text-center fade-in" onclick="event.stopPropagation()"><div class="text-amber-500 text-sm tracking-[0.3em] mb-6 font-bold" id="infoTitle">聖號功德</div><div class="text-white text-base leading-[2] font-medium tracking-[0.05em] text-left" id="infoContent"></div><button onclick="closeMantraInfo()" class="mt-10 px-12 py-2 border border-stone-700 text-stone-500 rounded-full text-xs font-bold tracking-widest">合十</button></div></div>
        <div id="gardenView" class="fixed inset-0 bg-black/95 z-[150] hidden flex-col items-center p-8 overflow-y-auto fade-in"><button onclick="closeGardenTab()" class="absolute top-12 right-6 text-white font-bold text-sm tracking-widest">返回主頁</button><h2 class="text-2xl font-bold text-amber-500 tracking-widest mt-20 mb-4 text-center">功德林境界</h2><div id="gardenGrid" class="flex flex-wrap justify-center gap-8 max-w-4xl mx-auto"></div></div>
        <div id="verseModal" class="fixed inset-0 z-[250] hidden items-center justify-center p-6 bg-black/60" onclick="closeVerse()"><div class="modal-base max-w-sm w-full p-10 rounded-3xl text-center fade-in" onclick="event.stopPropagation()"><div class="text-amber-500 text-sm tracking-[0.3em] mb-8 font-bold" id="verseGrade">上品上生</div><div class="text-white text-2xl leading-[2] font-bold tracking-[0.1em]" id="verseText"></div><button onclick="closeVerse()" class="mt-12 px-12 py-3 border border-stone-700 text-stone-500 rounded-full text-xs font-bold tracking-widest">合十</button></div></div>
        <div id="levelUpModal" class="fixed inset-0 bg-black/98 z-[200] hidden flex-col items-center justify-center text-center p-10 fade-in"><div id="modalLotus" class="w-48 h-48 mb-8 mx-auto"></div><h2 id="levelUpMsg" class="text-2xl font-bold text-amber-500 tracking-widest mb-4 text-center">今日功課圓滿</h2><p id="levelUpChoice" class="text-stone-300 mb-12 tracking-widest text-lg font-bold text-center">是否接續念誦進入下一境界？</p><div class="flex flex-col gap-4 w-full max-w-xs mx-auto"><button onclick="continueChanting()" class="w-full py-4 bg-amber-500 text-black rounded-full font-bold tracking-widest">接續念誦</button><button onclick="exitToDedication()" class="w-full py-4 border border-white/20 text-white rounded-full font-bold tracking-widest">圓滿收攝</button></div></div>
        <div id="dedicationView" class="fixed inset-0 bg-[#02040a] z-[300] hidden flex-col items-center justify-center text-center p-6 fade-in"><div class="text-amber-500 text-4xl mb-16 font-bold tracking-widest text-center">迴向偈</div><div class="space-y-6 text-xl text-stone-300 leading-relaxed font-bold text-center mx-auto"><div class="dedication-line">願以此功德。莊嚴佛淨土。</div><div class="dedication-line">上報四重恩。下濟三途苦。</div><div class="dedication-line">若有見聞者。悉發菩提心。</div><div class="dedication-line">盡此一報身。同生極樂國。</div></div><div class="mt-20 flex flex-col items-center gap-6 mx-auto"><div id="dedicationBottomMantra" class="text-amber-600/40 text-sm tracking-[0.5em] font-bold">南無阿彌陀佛</div><div class="flex flex-col gap-4 w-64"><button onclick="closeDedication()" class="w-full py-3 border border-amber-500/30 text-amber-500/80 rounded-full text-xs tracking-widest font-bold">返回修行</button><button onclick="endSession()" class="w-full py-3 bg-stone-900 text-stone-400 rounded-full text-xs font-bold border border-stone-800 tracking-widest">結束功課離開</button></div></div></div>
    </div>

    <script>
        /**
         * 萬德莊嚴 - 安全防護與核心邏輯
         * 版權所有：佛門修行者。禁止未經授權的商業改編與惡意代碼植入。
         */

        // --- 安全防護：完整性檢測與除錯防禦 ---
        (function guard() {
            // 1. 防止除錯器 (Anti-Debugger)
            setInterval(() => { (function(){}).constructor("debugger")(); }, 2000);

            // 2. 域名鎖定 (Domain Lock) - 預設為註釋狀態
            // 若要開啟，請將下行解開並替換為您的域名
            // if (window.location.hostname !== 'yourname.github.io') { document.body.innerHTML = '非法盜載或環境異常，請訪問官方網址。'; return; }

            // 3. 核心代碼指紋校驗 (簡單示範)
            const checksum = 20260218; 
            window._app_integrity = checksum;
        })();

        // --- 設定與數據 ---
        const TARGET = 108;
        const RINGS = [12, 24, 32, 40];
        const MANTRAS = {
            guanyin: { name: "南無觀世音菩薩", wheel: "南無觀世音菩薩", keywords: ["觀音", "世音", "菩薩", "薩"], type: "level", info: "《普門品》載：尋聲救苦，大慈大悲。持誦聖號能除一切災難，離火水之險，遠離恐懼、病苦與貪嗔癡。" },
            dizang: { name: "南無地藏王菩薩", wheel: "南無地藏王菩薩", keywords: ["地藏", "地藏王", "菩薩", "薩"], type: "level", info: "《地藏經》載：明珠照破鐵圍城。持誦聖號能滅除累世重罪，得衣食豐足，家宅安穩，並使先亡獲益。" },
            mani: { name: "嗡嘛呢貝美吽", wheel: "嗡嘛呢貝美吽", keywords: ["嗡", "嘛", "貝", "美", "吽", "阿"], type: "level", info: "觀音菩薩微妙心印。能閉六道之門（天、阿修羅、人、畜生、餓鬼、地獄），圓滿六波羅蜜。" },
            amitabha: { name: "南無阿彌陀佛", wheel: "南無阿彌陀佛", keywords: ["佛", "阿彌陀", "陀佛", "南無"], type: "amitabha", info: "萬德洪名，本願接引。持名念佛一聲，能滅八十億劫生死重罪。具足萬德，消除業障，極樂往生。" }
        };
        const AMITABHA_GRADES = [
            { name: "下品下生", color: "#B91C1C", verse: "五逆十惡<br>遇善知識<br>十念往生" }, { name: "下品中生", color: "#EA580C", verse: "遇善知識<br>聞佛名號<br>滅罪往生" }, { name: "下品上生", color: "#D97706", verse: "不謗大乘<br>化佛來迎<br>得生淨土" }, { name: "中品下生", color: "#65A30D", verse: "孝養父母<br>行世仁慈<br>臨終聞法" }, { name: "中品中生", color: "#0891B2", verse: "一日一夜<br>持八戒齋<br>清淨開瑕" }, { name: "中品上生", color: "#4F46E5", verse: "受持五戒<br>不造眾惡<br>聖眾現前" }, { name: "上品下生", color: "#9333EA", verse: "發菩提心<br>不謗大乘<br>化佛來迎" }, { name: "上品中生", color: "#F472B6", verse: "深信因果<br>解第一義<br>迴向往生" }, { name: "上品上生", color: "#FDE047", verse: "慈心不殺<br>具諸戒行<br>金剛台接" }
        ];
        const LEVEL_COLORS = [ "#3B82F6", "#10B981", "#F59E0B", "#EF4444", "#8B5CF6", "#EC4899", "#06B6D4", "#F43F5E", "#EAB308" ];

        let state = { selectedKey: null, level: 0, dailyCount: 0, totalAccumulated: 0, lastActive: Date.now(), animating: false, isLocked: false, voiceMode: false, currentView: 'home' };
        let recognition = null, lastVoiceCountTime = 0, wakeLock = null, audioCtx = null;

        // --- 螢幕保持開啟 Wake Lock ---
        async function requestWakeLock() { try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }
        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible' && state.currentView === 'practice') await requestWakeLock(); });

        // --- 圓滿警報 (嘟嘟嘟 5秒) ---
        function playCompletionBeeps() {
            return new Promise((resolve) => {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const duration = 5000, beepInterval = 300, startTime = audioCtx.currentTime;
                for (let t = 0; t < duration; t += beepInterval) {
                    const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
                    osc.type = 'sine'; osc.frequency.setValueAtTime(900, startTime + t / 1000);
                    gain.gain.setValueAtTime(0, startTime + t / 1000);
                    gain.gain.linearRampToValueAtTime(0.4, startTime + t / 1000 + 0.05);
                    gain.gain.linearRampToValueAtTime(0, startTime + t / 1000 + 0.2);
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.start(startTime + t / 1000); osc.stop(startTime + t / 1000 + 0.25);
                }
                setTimeout(resolve, duration);
            });
        }

        // --- 語音系統 ---
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;
            recognition = new SpeechRecognition();
            recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'zh-TW';
            recognition.onresult = (event) => {
                if (state.isLocked || !state.selectedKey || state.currentView !== 'practice') return;
                let interim = ''; for (let i = event.resultIndex; i < event.results.length; ++i) interim += event.results[i][0].transcript;
                if (MANTRAS[state.selectedKey].keywords.some(k => interim.includes(k))) {
                    const now = Date.now(); if (now - lastVoiceCountTime > 400) { lastVoiceCountTime = now; handleChant({ clientX: window.innerWidth / 2, clientY: window.innerHeight / 2 }); }
                }
            };
            recognition.onerror = () => { if(state.voiceMode) setTimeout(() => { try{recognition.start()}catch(e){} }, 300); };
            recognition.onend = () => { if (state.voiceMode) { try{recognition.start()}catch(e){} } };
        }

        function toggleVoiceMode() {
            if (!recognition) initSpeech();
            state.voiceMode = !state.voiceMode;
            document.getElementById('voiceBtn').className = `nav-link flex items-center gap-1 ${state.voiceMode ? 'voice-active' : ''}`;
            if (state.voiceMode) { try { recognition.start(); } catch(e) {} } else { try { recognition.stop(); } catch(e) {} }
            saveState();
        }

        // --- 核心邏輯 ---
        function selectMantra(key) {
            state.selectedKey = key; state.currentView = 'practice';
            loadData(key);
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('practiceUI').classList.remove('hidden');
            const center = document.getElementById('centerMantra');
            if (key === 'mani') center.innerHTML = "嗡嘛呢<br>貝美吽";
            else if (key === 'amitabha') center.innerHTML = "南無<br>阿彌陀佛";
            else center.innerHTML = MANTRAS[key].name.substring(0,2) + "<br>" + MANTRAS[key].name.substring(2);
            initWheel(); requestWakeLock();
        }

        function backToHome() {
            if (state.voiceMode) toggleVoiceMode();
            state.currentView = 'home'; saveState();
            document.getElementById('homeView').classList.remove('hidden');
            document.getElementById('practiceUI').classList.add('hidden');
            if (wakeLock) { wakeLock.release(); wakeLock = null; }
        }

        async function handleChant(e) {
            if (state.isLocked || state.animating || !state.selectedKey) return;
            if (document.querySelector('.fixed:not(.hidden):not(#notification)')) return;

            state.animating = true;
            const mouseX = (e && e.clientX) ? e.clientX : window.innerWidth / 2;
            const mouseY = (e && e.clientY) ? e.clientY : window.innerHeight / 2;

            const flash = document.createElement('div'); flash.className = 'sun-flash';
            flash.style.left = mouseX + 'px'; flash.style.top = mouseY + 'px';
            document.body.appendChild(flash); setTimeout(() => flash.remove(), 2500);

            const ripple = document.createElement('div'); ripple.className = 'ripple-ring';
            ripple.style.left = mouseX + 'px'; ripple.style.top = mouseY + 'px';
            document.body.appendChild(ripple); setTimeout(() => ripple.remove(), 4100);

            state.dailyCount++; state.totalAccumulated++;
            if (state.dailyCount >= TARGET) {
                state.isLocked = true;
                await playCompletionBeeps();
                showLevelUpModal();
            }
            saveState(); updateUI();
            setTimeout(() => { state.animating = false; }, 300);
        }

        function handleGlobalClick(e) {
            if (state.currentView !== 'practice' || e.target.closest('button') || e.target.closest('.nav-link')) return;
            handleChant(e);
        }

        function loadData(key) {
            const saved = localStorage.getItem(`lotus_mantra_vSec_${key}`);
            if (saved) { state = { ...state, ...JSON.parse(saved), voiceMode: false }; checkRegression(); }
            else { resetData(); }
            updateUI();
        }

        function saveState() {
            if (!state.selectedKey) return;
            state.lastActive = Date.now();
            localStorage.setItem(`lotus_mantra_vSec_${state.selectedKey}`, JSON.stringify(state));
        }

        function resetData() { state.level = 0; state.dailyCount = 0; state.totalAccumulated = 0; state.lastActive = Date.now(); state.isLocked = false; saveState(); }

        function checkRegression() {
            const now = Date.now();
            if (now - state.lastActive > 24 * 60 * 60 * 1000) {
                state.level = Math.max(0, state.level - 1); state.dailyCount = 0; state.isLocked = false; state.lastActive = now;
                const el = document.getElementById('notification'); el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 6000);
                saveState();
            }
        }

        function initWheel() {
            const wheel = document.getElementById('mantraWheel'); wheel.innerHTML = '';
            const mText = MANTRAS[state.selectedKey].wheel;
            let cumulative = 0;
            RINGS.forEach((num, ringIdx) => {
                const radius = 80 + ringIdx * 35;
                for (let i = 0; i < num; i++) {
                    const angle = (i * 360) / num, x = radius * Math.cos((angle * Math.PI) / 180), y = radius * Math.sin((angle * Math.PI) / 180);
                    const el = document.createElement('div'); el.id = `m-${cumulative}`; el.className = 'chant-unit absolute whitespace-nowrap pointer-events-none';
                    el.style.left = `calc(50% + ${x}px)`; el.style.top = `calc(50% + ${y}px)`;
                    el.style.transform = `translate(-50%, -50%) rotate(${angle + 90}deg)`;
                    el.style.color = '#0f172a'; el.innerText = mText;
                    wheel.appendChild(el); cumulative++;
                }
            });
            updateUI();
        }

        function updateUI() {
            if (!state.selectedKey) return;
            const m = MANTRAS[state.selectedKey];
            document.getElementById('gradeLabel').innerText = (m.type === 'amitabha' ? AMITABHA_GRADES[state.level].name : `第 ${state.level + 1} 階`);
            document.getElementById('subTitleLabel').innerText = (m.type === 'amitabha' ? "九品往生修行錄" : `${m.name}修行錄`);
            document.getElementById('progressLabel').innerText = `${state.dailyCount} / ${TARGET}`;
            document.getElementById('totalCountDisplay').innerText = state.totalAccumulated.toLocaleString();
            document.getElementById('dedicationBottomMantra').innerText = m.name;
            document.getElementById('lotusBtnContainer').style.opacity = state.isLocked ? "0.5" : "1";
            for(let i=0; i<TARGET; i++) {
                const el = document.getElementById(`m-${i}`);
                if (el) { el.style.color = (i < state.dailyCount ? '#fbbf24' : '#0f172a'); el.style.textShadow = (i < state.dailyCount ? '0 0 10px #fbbf24' : 'none'); }
            }
        }

        function showMantraInfo() { const m = MANTRAS[state.selectedKey]; document.getElementById('infoTitle').innerText = `${m.name} 功德說明`; document.getElementById('infoContent').innerText = m.info; document.getElementById('infoModal').style.display = 'flex'; }
        function closeMantraInfo() { document.getElementById('infoModal').style.display = 'none'; }
        function showGardenTab() {
            const grid = document.getElementById('gardenGrid'); grid.innerHTML = '';
            const m = MANTRAS[state.selectedKey];
            if (m.type === 'amitabha') {
                AMITABHA_GRADES.forEach((g, i) => {
                    const item = document.createElement('div'); item.className = `flex flex-col items-center transition-all ${i <= state.level ? 'opacity-100' : 'opacity-10 grayscale'}`;
                    item.onclick = i <= state.level ? () => showVerse(i) : null;
                    item.innerHTML = `${getLotusSVG(g.color, 85)}<p class="text-[10px] font-bold text-stone-400 mt-2">${g.name}</p>`;
                    grid.appendChild(item);
                });
            } else {
                for(let i=0; i<9; i++) {
                    const item = document.createElement('div'); item.className = `flex flex-col items-center transition-all ${i <= state.level ? 'opacity-100' : 'opacity-10 grayscale'}`;
                    item.innerHTML = `${getLotusSVG(LEVEL_COLORS[i], 85)}<p class="text-[10px] font-bold text-stone-400 mt-2">第 ${i+1} 階</p>`;
                    grid.appendChild(item);
                }
            }
            document.getElementById('gardenView').style.display = 'flex';
        }
        function closeGardenTab() { document.getElementById('gardenView').style.display = 'none'; }
        function getLotusSVG(color, size) {
            let petals = ''; for(let i=0; i<24; i++) petals += `<path d="M50 50 Q65 15 50 0 Q35 15 50 50" stroke="${color}" transform="rotate(${i*15}, 50, 50)" stroke-width="0.5" fill="none" stroke-opacity="0.6" />`;
            return `<svg viewBox="0 0 100 100" width="${size}" height="${size}"><circle cx="50" cy="50" r="25" fill="${color}" style="filter:blur(12px); opacity: 0.3;" />${petals}<circle cx="50" cy="50" r="5" fill="#fbbf24" /></svg>`;
        }
        function showVerse(idx) { document.getElementById('verseGrade').innerText = AMITABHA_GRADES[idx].name; document.getElementById('verseText').innerHTML = AMITABHA_GRADES[idx].verse; document.getElementById('verseModal').style.display = 'flex'; }
        function closeVerse() { document.getElementById('verseModal').style.display = 'none'; }
        function showLevelUpModal() {
            const m = MANTRAS[state.selectedKey], color = (m.type === 'amitabha') ? AMITABHA_GRADES[state.level].color : LEVEL_COLORS[state.level];
            document.getElementById('levelUpMsg').innerText = (m.type === 'amitabha' ? AMITABHA_GRADES[state.level].name : `第 ${state.level+1} 階`) + " 功德圓滿";
            document.getElementById('modalLotus').innerHTML = getLotusSVG(color, 180);
            document.getElementById('levelUpChoice').innerText = state.level >= 8 ? "已臻最高境界，是否持續念誦精進？" : "是否接續念誦進入下一境界？";
            document.getElementById('levelUpModal').style.display = 'flex';
        }
        function continueChanting() { if (state.level < 8) state.level++; state.dailyCount = 0; state.isLocked = false; saveState(); document.getElementById('levelUpModal').style.display = 'none'; initWheel(); updateUI(); }
        function showDedication() { document.getElementById('dedicationView').style.display = 'flex'; }
        function closeDedication() { document.getElementById('dedicationView').style.display = 'none'; }
        function exitToDedication() { document.getElementById('levelUpModal').style.display = 'none'; showDedication(); }
        function endSession() { saveState(); location.reload(); }

        window.onload = () => {
            const last = Object.keys(MANTRAS).find(k => localStorage.getItem(`lotus_mantra_vSec_${k}`));
            if (last) { const s = JSON.parse(localStorage.getItem(`lotus_mantra_vSec_${last}`)); if (s && s.selectedKey) selectMantra(last); }
        };
        setInterval(() => { if (state.selectedKey) { checkRegression(); updateUI(); } }, 60000);
    </script>
</body>
</html>

